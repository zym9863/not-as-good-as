# 交互流程与可访问性/动画规范

本文档覆盖核心操作（封存/漂流/只读锁定/解封）的详细流程、确认策略与异常分支，并定义可访问性（A11y）与动画规范，确保“仪式感”与可用性兼得。

---

## 一、核心交互流程

### 1) 创建回忆（Create Memory）
入口：`/memories/new`

步骤：
1. 选择类型：text / image / audio / date
2. 填写/上传内容：
   - text：多行文本
   - image：上传 1-N 张图片（本地预览）
   - audio：录音或上传音频（权限拒绝时回退为上传）
   - date：选择纪念日（ISO）
3. 校验与提交：
   - 必填项校验（至少满足对应类型的必需内容）
   - 大文件/数量限制校验（见“限制”）
4. 成功：Toast“回忆已创建”，跳转 `/memories`
5. 失败：展示错误消息，保持表单数据不丢失

异常分支：
- 录音权限拒绝：提示并切换为文件上传
- IndexedDB 不可用：提示降级存储（无 Blob）

---

### 2) 封存（Seal）
入口：`/memories/:id` 详情页按钮“封存”

步骤：
1. 打开 `SealDialog`（模态）
2. 设置未来解锁日期（DateTimePicker）
3. 确认提示文案（仪式感）：
   - 示例：“把爱藏在相遇的缝隙，未来某日再见”
4. 校验：
   - 解锁日期必须晚于当前时间
5. 提交：更新记录 `status=sealed`，写入 `sealedUntil`
6. 成功：关闭模态，Toast“已封存至 YYYY-MM-DD”，详情页显示封存卡或返回列表

异常分支：
- 日期无效或未选择：表单错误态
- 存储失败：保留模态并提示重试

列表展示策略：
- 默认隐藏未到期封存项
- “显示封存”开关打开后显示封存卡（遮蔽内容，仅露出封存图标与解锁日期）

---

### 3) 解封（Unseal）
触发条件：访问列表或详情时发现 `status=sealed && sealedUntil <= now`

逻辑：
1. 内存态即时视为 active（无需用户操作）
2. 可选：在下次合适的写入时机将持久层同步更新为 active
3. UI：从封存卡切换为正常内容展示（无突兀动画，或使用轻微“解封启封”过渡）

异常分支：
- 时间边界：等于当前时间应视为到期
- 同步失败：仅影响持久层标记，不影响视图展示（下次重试）

---

### 4) 漂流（Let Go，永久删除）
入口：`/memories/:id` 详情页按钮“让它漂流”

两步确认与动画：
1. 第一步确认模态（ConfirmModal-1）
   - 文案：强调不可恢复
   - 操作：继续 / 取消
2. 第二步确认模态（ConfirmModal-2）
   - 勾选“我理解这将无法找回”
   - 操作：开始漂流
3. 进入漂流动画（`DriftAnimation`）
   - 动画结束回调：执行物理删除（记录与 Blob），导航返回 `/memories`
4. 成功：Toast“愿你安好，风浪一路向前”
5. 失败：若删除失败，提示错误并回到详情页（记录仍在）

异常分支：
- 用户中断：取消任意一步即终止流程
- 动画被跳过（低动效模式）：直接删除 → 返回列表

---

### 5) 初遇（First Encounter）锁定只读
入口：`/first-encounter`

状态机：
- NotCreated：未创建 → 渲染 `FirstEncounterEditor`
- Editable：已创建未锁定 → 仍渲染 `FirstEncounterEditor`
- Locked：`locked=true` → 渲染 `FirstEncounterView`（只读）

锁定流程：
1. 在编辑界面点击“锁定初遇”
2. 确认模态：说明锁定不可逆
3. 提交：设置 `locked=true`
4. 成功：切换只读视图，Toast“初遇已被珍藏”
5. 存储层守卫：当 `locked=true` 时拒绝后续写入请求

异常分支：
- 未保存内容直接锁定：允许（用当前编辑内容提交并锁定），或提示“先保存再锁定”（两种策略任选一种，建议第一种以减少步骤）
- 存储失败：不更改 UI 状态并提示

---

## 二、可访问性（A11y）规范

### 1) 键盘可达与焦点管理
- 所有可交互元素可通过 Tab 顺序访问
- 模态（Dialog）开启后：
  - 焦点陷阱在模态内部
  - Esc 关闭（在漂流第二步确认可选择强制不允许 Esc 关闭，防误触）
  - 初始焦点落在标题或主要按钮上
- 按钮与链接使用语义化元素（button/a），提供 aria-label（当文案不充分时）

### 2) 语义与可感知反馈
- Toast/错误提示对屏幕阅读器可见（aria-live="polite"/"assertive"）
- 表单错误采用 aria-invalid，关联错误描述（aria-describedby）

### 3) 颜色与对比度
- 遵循 WCAG AA（对比度≥4.5:1）
- 提供可见的焦点外观（focus ring）

### 4) 可见性与内容遮蔽
- 封存卡遮蔽内容时，不将真实内容渲染至 DOM（或以安全方式渲染以避免被复制）

---

## 三、动画规范

### 1) 动效准则
- 首要：不妨碍可用性；动画仅作为“仪式感”加分
- 尊重系统偏好：`@media (prefers-reduced-motion: reduce)` 降低或禁用动画
- 时长基准：
  - 微交互：150–250ms
  - 封存/解封过渡：300–400ms
  - 漂流动画：800–1200ms（低动效模式下 0–200ms）

### 2) 漂流动画（DriftAnimation）
- 视觉：瓶子沿波浪缓慢远离，透明度渐减
- 技术：CSS keyframes + transform（GPU 加速），或 Lottie JSON
- 事件：`onFinished()` 回调触发删除与导航
- 可中断：在低动效或性能较差设备直接跳过动画

### 3) 封存仪式（SealDialog）
- 视觉：微粒/光晕向瓶口收拢，胶囊合拢
- 声音（可选）：轻微“合盖”音效，提供静音开关

### 4) 解封过渡
- 视觉：轻微亮度提升与遮罩消退（避免突兀）

---

## 四、限制与阈值建议

- 图片：
  - 单文件 ≤ 5MB，最多 10 张
  - 超出提示压缩或减少数量
- 音频：
  - 单文件 ≤ 10MB
  - 录音时长建议 ≤ 3 分钟
- 文本：
  - 文本长度 ≤ 10,000 字符（前端校验）
- 存储：
  - IndexedDB 空间受浏览器限制（通常数百 MB 级别），错误时友好提示

---

## 五、错误与异常处理统一规范

- 统一错误组件：在页面顶部/区域内显示错误条幅，配合 Toast
- 统一重试入口：可重试操作提供“重试”按钮
- 不可逆操作（漂流/锁定）：
  - 始终使用模态确认
  - 默认需要额外勾选“我理解后果”
- 辅助日志：开发态在控制台输出详细错误；生产态仅提示用户友好消息

---

## 六、接口与事件约定（前端）

- `DriftAnimation`：
  - props: `{ onFinished: () => void; reducedMotion?: boolean }`
- `SealDialog`：
  - props: `{ defaultDate?: string; onConfirm: (iso: string) => void; onCancel: () => void }`
- `ConfirmModal`：
  - props: `{ title: string; description?: string; requireAcknowledge?: boolean; onConfirm: () => void; onCancel: () => void }`

---

## 七、QA 清单（验收前自测）

- [ ] Tab 顺序合理，模态可完全用键盘完成
- [ ] prefers-reduced-motion 下动画显著降低或关闭
- [ ] 封存日期边界（=now）按到期处理
- [ ] 漂流双确认与“理解不可恢复”必须勾选
- [ ] 漂流失败时记录未丢失，动画不导致数据不一致
- [ ] 锁定后任何写入均被拒绝（前端与存储层守卫）